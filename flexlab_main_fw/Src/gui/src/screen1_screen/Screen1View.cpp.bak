#include <gui/screen1_screen/Screen1View.hpp>

#include <BitmapDatabase.hpp>
#include <texts/TextKeysAndLanguages.hpp>

#include "rtc.h"

RTC_TimeTypeDef sTime;
RTC_DateTypeDef sDate;
	

Screen1View::Screen1View():
	ContainerClickCallback(this, &Screen1View::ContainerClickHandler),//!
	layer_infoClickCallback(this, &Screen1View::layer_infoClickHandler)
{

}

void Screen1View::setupScreen()
{	
		//加载外部Flash中的存储内容，缓存到SDRAM的(uint16_t *)0xd0300000之后的0x400000的大小空间，最多加载128个文件
		Bitmap::setCache((uint16_t *)0xc0600000,0x1000000,128);
		Bitmap::cacheAll();

		Screen1ViewBase::setupScreen();
	
		myLens1.setXY(140, 40);
		myLens1.setLensBackgroundBitmap(BITMAP_LENS_IMAGE_ID);
//		add(myLens1);
		
		presenter->get_layer_status(&layer_status[0], 0);
		presenter->get_layer_status(&layer_status[1], 1);
		presenter->get_layer_status(&layer_status[2], 2);
	
		sys_info.setClickAction(ContainerClickCallback);//!
		layer_info_1.setClickAction(layer_infoClickCallback);//!
		layer_info_2.setClickAction(layer_infoClickCallback);//!
		layer_info_3.setClickAction(layer_infoClickCallback);//!
		cabinet_info.setClickAction(ContainerClickCallback);//!
		
		HAL_RTC_GetTime(&hrtc, &sTime, RTC_FORMAT_BIN);
		HAL_RTC_GetDate(&hrtc, &sDate, RTC_FORMAT_BIN);
	
		Unicode::snprintf(timeBuffer, TIME_SIZE, (uint16_t*)L"%d:%02d", sTime.Hours, sTime.Minutes);
		Unicode::snprintf(dateBuffer, DATE_SIZE, (uint16_t*)L"%04d年%d月%d日", sDate.Year, sDate.Month, sDate.Date);
		
		layer_info_1.set_layer_number(1);
		layer_info_2.set_layer_number(2);
		layer_info_3.set_layer_number(3);
		
		layer_info_1.set_layer_state(layer_status[0].layer_state);
		layer_info_2.set_layer_state(layer_status[1].layer_state);
		layer_info_3.set_layer_state(layer_status[2].layer_state);
		
		layer_info_1.invalidate();
		layer_info_2.invalidate();
		layer_info_3.invalidate();
		sys_info.invalidate();
}

void Screen1View::tearDownScreen()
{
    Screen1ViewBase::tearDownScreen();
}

void Screen1View::ContainerClickHandler(const Container& ct, const ClickEvent& evt)//!
{
	static int8_t temp; 
	static bool nus_level[3]={true,false,false};
	
    if (&ct == &sys_info && evt.getType()==evt.PRESSED)
    {

    }
	else if (&ct == &cabinet_info && evt.getType()==evt.PRESSED)
	{		
			temp++;
			set_cabinet_infomation(temp, true, nus_level);
	}
}

void Screen1View::layer_infoClickHandler(const layer_info& li, const ClickEvent& evt)//!
{
	if (&li == &layer_info_1 && evt.getType()==evt.PRESSED)
	{
			presenter->set_enter_layer(1);
			application().gotoScreen2ScreenWipeTransitionWest();
	}
	else if (&li == &layer_info_2 && evt.getType()==evt.PRESSED)
	{
			presenter->set_enter_layer(2);
			application().gotoScreen2ScreenWipeTransitionWest();
	}
	else if (&li == &layer_info_3 && evt.getType()==evt.PRESSED)
	{
			presenter->set_enter_layer(3);
			application().gotoScreen2ScreenWipeTransitionWest();
	}
}

void Screen1View::handleTickEvent()
{
		HAL_RTC_GetTime(&hrtc, &sTime, RTC_FORMAT_BIN);
		HAL_RTC_GetDate(&hrtc, &sDate, RTC_FORMAT_BIN);
	
		if(sTime.SubSeconds>127)
				Unicode::snprintf(timeBuffer, TIME_SIZE, (uint16_t*)L"%d:%02d", sTime.Hours, sTime.Minutes);
		else
				Unicode::snprintf(timeBuffer, TIME_SIZE, (uint16_t*)L"%d %02d", sTime.Hours, sTime.Minutes);
		
		Unicode::snprintf(dateBuffer, DATE_SIZE, (uint16_t*)L"20%02d年%d月%d日", sDate.Year, sDate.Month, sDate.Date);
		
		sys_info.invalidate();
}

void Screen1View::set_cabinet_infomation(int8_t temp, bool w_level, bool *nus_level)
{
		Unicode::snprintf(c_info_tempBuffer, C_INFO_TEMP_SIZE, (uint16_t*)L"%d", temp);
	
		if(w_level)
			Unicode::snprintf(c_info_wlevelBuffer, C_INFO_WLEVEL_SIZE, (uint16_t*)L"正常");
		else
			Unicode::snprintf(c_info_wlevelBuffer, C_INFO_WLEVEL_SIZE, (uint16_t*)L"缺水");
		
		if(nus_level[0])
			Unicode::snprintf(c_nus1_infoBuffer, C_NUS1_INFO_SIZE, (uint16_t*)L"充足");
		else
			Unicode::snprintf(c_nus1_infoBuffer, C_NUS1_INFO_SIZE, (uint16_t*)L"缺料");
		
		if(nus_level[1])
			Unicode::snprintf(c_nus2_infoBuffer, C_NUS2_INFO_SIZE, (uint16_t*)L"充足");
		else                                        
			Unicode::snprintf(c_nus2_infoBuffer, C_NUS2_INFO_SIZE, (uint16_t*)L"缺料");
		
		if(nus_level[2])
			Unicode::snprintf(c_nus3_infoBuffer, C_NUS3_INFO_SIZE, (uint16_t*)L"充足");
		else                                        
			Unicode::snprintf(c_nus3_infoBuffer, C_NUS3_INFO_SIZE, (uint16_t*)L"缺料");
		
		cabinet_info.invalidate();
}

void Screen1View::zoomButtonPressed()
{
	static bool zoom_flag;
	
	if(zoom_flag==false)
	{
		add(myLens1);
		zoom_flag=true;
	}
	else
	{
		remove(myLens1);
		zoom_flag=false;
	}	
	
	invalidate();	
}
